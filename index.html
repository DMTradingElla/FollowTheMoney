<!DOCTYPE html>
<html lang="zh-Hant">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>錢包交易明細整理器</title>
  <!-- XLSX 讀取：SheetJS -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <!-- docx.js：先走 cdnjs，後面 JS 會再做 CDN fallback -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/docx/8.5.0/docx.umd.min.js"></script>
  <!-- FileSaver：穩定下載 -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <style>
    :root {
      --bg: #0f172a;
      --card: #111827;
      --fg: #e5e7eb;
      --muted: #9ca3af;
      --accent: #22d3ee;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans TC", Helvetica, Arial;
      background: linear-gradient(180deg, #0b1220, #0f172a);
      color: var(--fg);
    }

    .wrap {
      max-width: 1100px;
      margin: 40px auto;
      padding: 24px;
    }

    .card {
      background: rgba(17, 24, 39, .6);
      border: 1px solid #1f2937;
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, .25);
    }

    h1 {
      font-size: 28px;
      margin: 0 0 8px;
      letter-spacing: .5px;
      text-align: left;
    }

    .actions {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
      margin: 16px 0 6px;
    }

    .btn {
      border: 1px solid #334155;
      background: #0b1220;
      color: #e5e7eb;
      padding: 10px 14px;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 600;
    }

    .btn[disabled] {
      opacity: .5;
      cursor: not-allowed;
    }

    .btn:hover:not([disabled]) {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(34, 211, 238, .15) inset;
    }

    input[type=file] {
      display: none;
    }

    label[for=files] {
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .hint {
      font-size: 12px;
      color: var(--muted);
    }

    .grid {
      overflow: auto;
      border: 1px solid #1f2937;
      border-radius: 12px;
      margin-top: 14px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 960px;
    }

    th,
    td {
      border-bottom: 1px solid #202938;
      padding: 10px 12px;
      text-align: left;
      font-size: 13.5px;
    }

    th {
      position: sticky;
      top: 0;
      background: #0b1220;
      z-index: 1;
    }

    .ok {
      color: #22d3ee;
    }

    .err {
      color: #f87171;
    }

    .badge {
      border: 1px solid #334155;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 12px;
      color: #93c5fd;
    }

    .filelist {
      margin-top: 10px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 10px;
    }

    .chip {
      background: #0b1220;
      border: 1px solid #1f2937;
      border-radius: 12px;
      padding: 8px 10px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    .chip b {
      color: #cbd5e1;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .chip .meta {
      color: #94a3b8;
      font-size: 12px;
    }

    .chip .del {
      border: 1px solid #334155;
      background: transparent;
      color: #e5e7eb;
      border-radius: 8px;
      padding: 2px 8px;
      cursor: pointer;
    }

    .chip .del:hover {
      border-color: #f87171;
      color: #f87171;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <h1>錢包交易明細整理器</h1>
      <div class="actions">
        <input id="files" type="file" multiple
          accept=".xlsx,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" />
        <label for="files" class="btn">新增 Excel 檔</label>
        <button id="btnExportTable" class="btn" disabled>匯出總表</button>
        <span id="status" class="hint"></span>
      </div>

      <div id="fileSummary" class="filelist"></div>

      <div class="grid" id="previewGrid" style="display:none">
        <table id="previewTable">
          <thead>
            <tr>
              <th>時間</th>
              <th>交易哈希</th>
              <th>發送地址</th>
              <th>接收地址</th>
              <th>金額(幣種)</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    (() => {
      const $ = (q) => document.querySelector(q);
      const XLSX_NS = window.XLSX;

      const statusEl = $('#status');
      const btnExportTable = $('#btnExportTable');
      const previewGrid = $('#previewGrid');
      const previewBody = $('#previewTable tbody');
      const fileSummary = $('#fileSummary');
      const fileInput = $('#files');

      const MAX_PREVIEW_ROWS = 2000;

      let DOCX = null;
      async function ensureDocx() {
        const ok = () => (window.docx && typeof window.docx.Document === 'function');
        if (ok()) { DOCX = window.docx; return; }
        await loadScript('https://cdn.jsdelivr.net/npm/docx@8.5.0/build/index.umd.js').catch(() => { });
        if (ok()) { DOCX = window.docx; return; }
        await loadScript('https://unpkg.com/docx@8.5.0/build/index.umd.js').catch(() => { });
        if (ok()) { DOCX = window.docx; return; }
        throw new Error('docx 函式庫無法載入（網路或 CDN 被擋）。');
      }

      function loadScript(src) {
        return new Promise((res, rej) => {
          const s = document.createElement('script');
          s.src = src; s.async = true; s.onload = () => res(); s.onerror = (e) => rej(e);
          document.head.appendChild(s);
        });
      }

      const state = {
        items: new Map(),
      };

      function makeKey(file) { return `${file.name}|${file.size}|${file.lastModified}`; }

      function normalize(s) { return String(s ?? '').replace(/\s+/g, '').toLowerCase(); }

      const ALIASES = {
        time: ['時間', '交易時間', 'time', 'datetime', 'timestamp', '日期', '成交時間', 'createat', 'createdat'],
        hash: ['交易哈希', '交易哈希值', '交易hash', 'hash', 'txid', '交易id', '交易編號', '交易代碼', '交易序號', '交易碼', 'txhash'],
        from: ['發送地址', '發送錢包地址', '發送方地址', '付款地址', 'from', 'fromaddress', 'sender', 'senderaddress', '交易方地址', '打款地址', '匯出地址', '付款錢包地址'],
        to: ['接收地址', '接收錢包地址', '收款地址', '收款錢包地址', 'to', 'toaddress', 'receiver', 'receiveraddress', '收款方地址', '入金地址', '對方地址'],
        amount_with_ccy: ['交易金額(幣種)', '金額(幣種)', '金額與幣種', 'amount(currency)', 'amt(ccy)', 'value', '數量(幣種)', '金額幣種', '幣種金額'],
        amount: ['金額', '交易金額', 'amount', '數量', 'qty', 'value', '金額(usd)', 'usdt金額', '金額usdt'],
        currency: ['幣種', '幣別', 'token', 'coin', 'symbol', 'currency', 'ccy'],
      };

      function pickColumns(headers) {
        const found = { time: null, hash: null, from: null, to: null, amount_with_ccy: null, amount: null, currency: null };
        headers.forEach(h => {
          const norm = normalize(h);
          for (const key of Object.keys(ALIASES)) {
            for (const alias of ALIASES[key]) {
              const an = normalize(alias);
              if (norm === an || norm.includes(an)) {
                if (!found[key]) found[key] = h;
              }
            }
          }
        });
        return found;
      }

      function formatAmount(v) {
        if (v == null) return '';
        let s = String(v).replace(/,/g, '').trim();
        s = s.replace(/\s+/g, ' ');
        s = s.replace(/([0-9])([A-Za-z])/g, '$1 $2');
        const m = s.match(/^\s*([+-]?\d+(?:\.\d+)?)\s*([A-Za-z]{2,10})?\s*$/);
        if (m) {
          let num = Number(m[1]);
          let out = (Number.isFinite(num) ? num.toString() : m[1]);
          if (out.includes('.')) out = out.replace(/0+$/, '').replace(/\.$/, '');
          const ccy = (m[2] || '').toUpperCase();
          return ccy ? `${out} ${ccy}` : out;
        }
        return String(v);
      }

      function toRows(sheet) {
        const json = XLSX_NS.utils.sheet_to_json(sheet, { defval: '' });
        if (json.length === 0) return [];

        const headers = Object.keys(json[0]);
        const cols = pickColumns(headers);

        const rows = [];
        for (const r of json) {
          const t = r[cols.time] ?? '';
          const h = r[cols.hash] ?? '';
          const f = r[cols.from] ?? '';
          const to = r[cols.to] ?? '';
          let amountText = '';
          const awc = cols.amount_with_ccy ? r[cols.amount_with_ccy] : '';
          if (awc) { amountText = formatAmount(awc); }
          else {
            const a = cols.amount ? r[cols.amount] : '';
            const c = cols.currency ? r[cols.currency] : '';
            const aTxt = formatAmount(a);
            const cTxt = String(c || '').trim();
            amountText = aTxt && cTxt ? `${aTxt} ${cTxt.toUpperCase()}` : (aTxt || cTxt);
          }

          const allBlank = [t, h, f, to, amountText].every(v => String(v).trim() === '');
          if (allBlank) continue;

          rows.push({ '時間': String(t), '交易哈希': String(h), '發送地址': String(f), '接收地址': String(to), '金額(幣種)': String(amountText) });
        }
        return rows;
      }

      async function parseAndAddFiles(fileList) {
        for (const f of fileList) {
          const key = makeKey(f);
          if (state.items.has(key)) continue;
          const buf = await f.arrayBuffer();
          const wb = XLSX_NS.read(buf, { type: 'array' });
          let pickedSheetName = null; let rows = [];
          for (const sn of wb.SheetNames) {
            const sh = wb.Sheets[sn];
            rows = toRows(sh);
            if (rows.length) { pickedSheetName = sn; break; }
          }
          state.items.set(key, { key, file: f, name: f.name.replace(/\.[^.]+$/, ''), size: f.size, lastModified: f.lastModified, rows, sheetName: pickedSheetName || wb.SheetNames[0] || 'Sheet1' });
        }
        renderAll();
      }

      function removeFile(key) {
        state.items.delete(key);
        renderAll();
      }

      function renderAll() {
        fileSummary.innerHTML = '';
        const list = Array.from(state.items.values());
        for (const item of list) {
          const div = document.createElement('div');
          div.className = 'chip';
          div.innerHTML = `<div><b title="${item.file.name}">${item.name}</b> <span class="meta">sheet: ${item.sheetName} ・ 資料數: ${item.rows.length}</span></div><button class="del" data-key="${item.key}">×</button>`;
          fileSummary.appendChild(div);
        }
        fileSummary.onclick = (e) => {
          const btn = e.target.closest('.del');
          if (btn) { removeFile(btn.dataset.key); }
        };

        previewBody.innerHTML = '';
        let count = 0;
        for (const item of list) {
          for (const r of item.rows) {
            if (count >= MAX_PREVIEW_ROWS) break;
            const tr = document.createElement('tr');
            const td0 = document.createElement('td'); td0.textContent = item.name; tr.appendChild(td0);
            ['時間', '交易哈希', '發送地址', '接收地址', '金額(幣種)'].forEach(k => {
              const td = document.createElement('td');
              td.textContent = r[k] ?? '';
              tr.appendChild(td);
            });
            previewBody.appendChild(tr);
            count++;
          }
          if (count >= MAX_PREVIEW_ROWS) break;
        }
        const hasRows = list.some(it => it.rows.length);
        previewGrid.style.display = hasRows ? 'block' : 'none';

        const total = list.reduce((a, b) => a + b.rows.length, 0);
        statusEl.innerHTML = hasRows ? `<span class="ok">就緒。檔案數：${list.length}，總列數：${total}。</span>` : '<span class="hint">尚未加入檔案</span>';
        btnExportTable.disabled = !hasRows;
      }

      function saveBlob(blob, fileName) {
        try {
          if (window.saveAs) { window.saveAs(blob, fileName); return; }
          if (navigator.msSaveOrOpenBlob) { navigator.msSaveOrOpenBlob(blob, fileName); return; }
          const a = document.createElement('a');
          a.href = URL.createObjectURL(blob);
          a.download = fileName;
          document.body.appendChild(a); a.click(); a.remove();
        } catch (err) { console.error('saveBlob failed:', err); alert('下載失敗'); }
      }

      async function exportAsSingleTable() {
        await ensureDocx();
        const { Document, Packer, Paragraph, Table, TableRow, TableCell, TextRun, WidthType, AlignmentType, BorderStyle } = DOCX;
        const doc = new Document({ sections: [], styles: { default: { document: { run: { font: 'Microsoft JhengHei', size: 20 } } } } });

        const title = new Paragraph({ children: [new TextRun({ text: '錢包交易明細整理', bold: true, size: 28 })], alignment: AlignmentType.CENTER });

        const colWidths = [2200, 3600, 3200, 3200, 1800];
        const headerCells = ['時間', '交易哈希', '發送地址', '接收地址', '金額(幣種)'].map((t, i) => new TableCell({
          width: { size: colWidths[i], type: WidthType.DXA },
          margins: { top: 80, bottom: 80, left: 120, right: 120 },
          children: [new Paragraph({ children: [new TextRun({ text: t, bold: true })] })],
          shading: { fill: 'E5E7EB' },
        }));
        const headerRow = new TableRow({ children: headerCells });

        const rows = [];
        for (const item of Array.from(state.items.values())) {
          for (const r of item.rows) {
            const cells = [
              String(r['時間'] || ''),
              String(r['交易哈希'] || ''),
              String(r['發送地址'] || ''),
              String(r['接收地址'] || ''),
              String(r['金額(幣種)'] || '').replace(/\s+/g, ' ')
            ].map((txt, i) => new TableCell({
              width: { size: colWidths[i], type: WidthType.DXA },
              margins: { top: 80, bottom: 80, left: 120, right: 120 },
              children: [new Paragraph({ children: [new TextRun({ text: txt, size: 20 })] })]
            }));
            rows.push(new TableRow({ children: cells }));
          }
        }

        const table = new Table({
          width: { size: 100, type: WidthType.PERCENTAGE },
          columnWidths: colWidths,
          borders: {
            top: { style: BorderStyle.SINGLE, size: 4, color: '000000' },
            bottom: { style: BorderStyle.SINGLE, size: 4, color: '000000' },
            left: { style: BorderStyle.SINGLE, size: 4, color: '000000' },
            right: { style: BorderStyle.SINGLE, size: 4, color: '000000' },
            insideH: { style: BorderStyle.SINGLE, size: 4, color: '000000' },
            insideV: { style: BorderStyle.SINGLE, size: 4, color: '000000' },
          },
          rows: [headerRow, ...rows]
        });

        doc.addSection({ children: [title, new Paragraph({ text: '' }), table] });

        const blob = await DOCX.Packer.toBlob(doc);
        saveBlob(blob, `交易明細整理.docx`);
      }

      fileInput.addEventListener('change', async (e) => {
        const files = Array.from(e.target.files || []);
        if (!files.length) return;
        statusEl.textContent = '解析中…';
        btnExportTable.disabled = true;
        await parseAndAddFiles(files);
        fileInput.value = '';
      });

      btnExportTable.addEventListener('click', exportAsSingleTable);
    })();
  </script>
</body>

</html>